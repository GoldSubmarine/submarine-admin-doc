(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{354:function(t,e,a){"use strict";a.r(e);var s=a(42),r=Object(s.a)({},(function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"文件存储"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#文件存储"}},[t._v("#")]),t._v(" 文件存储")]),t._v(" "),a("h2",{attrs:{id:"实现思路"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#实现思路"}},[t._v("#")]),t._v(" 实现思路")]),t._v(" "),a("ol",[a("li",[t._v("不要用用户上传的图片文件名做为文件名直接存储，容易产生冲突")]),t._v(" "),a("li",[t._v("不要用连续递增的数字做文件 id，避免图片被直接遍历爬走了")]),t._v(" "),a("li",[t._v("同一个文件夹下的文件个数不宜太多，否则读取文件的速度会变慢。Linux Ext2，测试单目录 3000 文件是个瓶颈")])]),t._v(" "),a("p",[t._v("综上要点，这里采用 uuid 做为磁盘文件名，并截取 uuid 的前 6 位做 3 级目录，例如："),a("code",[t._v("/9b/3b/94/9b3b9424-862d-40ca-ad81-9eeda9d30422")]),t._v("，因为 uuid 的前 6 位和时间相关，所以可以保证文件随机分散在各个目录。每个文件夹假设最多 1024 个文件，则存储容量可以达到 36^6*1024 个文件")]),t._v(" "),a("p",[t._v("这里不采用 md5，如果用 md5 可能会出现重复上传，文件名相同的情况，因为使用场景并非网盘，重复率很小，所以用 uuid 重复存储即可。")]),t._v(" "),a("p",[t._v("用 uuid 的好处还有可以直接删除文件，不会留下无用文件，如果是 MD5 可能会有多个业务应用同一个文件，就无法删除。")]),t._v(" "),a("h2",{attrs:{id:"代码实现"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#代码实现"}},[t._v("#")]),t._v(" 代码实现")]),t._v(" "),a("p",[t._v("所有文件的增删改查操作都应通过 FileStoreService 完成，FileStoreService 主要做两件事：")]),t._v(" "),a("ol",[a("li",[t._v("更新数据库总的文件信息")]),t._v(" "),a("li",[t._v("将文件保存到磁盘")])]),t._v(" "),a("p",[t._v("不管哪种方式，步骤 1 都是相同的，不同的是存储方式不一样，所以定义了 HandleFile 接口，用于存储、删除、下载文件，这里已经实现了"),a("code",[t._v("local")]),t._v(" 和 "),a("code",[t._v("oss")]),t._v("两种存储方式，如果你有其他需求，自行实现 HandleFile 接口即可")]),t._v(" "),a("p",[t._v("配合"),a("code",[t._v("@ConditionalOnProperty")]),t._v("注解，就可以在配置文件中指定采用哪种存储方式：")]),t._v(" "),a("div",{staticClass:"language-yml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("upload")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" local "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 切换方式")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("local")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("path")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ./src/main/resources/public/\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("oss")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" xxxx "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 上传到某一个文件夹")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("endpoint")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" xxxx\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("viewEndpoint")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" xxxx\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("accessKeyId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" xxxx\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("accessKeySecret")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" xxxx\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("bucketName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" xxxx\n")])])]),a("h2",{attrs:{id:"前端使用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前端使用"}},[t._v("#")]),t._v(" 前端使用")]),t._v(" "),a("p",[t._v("业务表中存储的都是 file_store 表的 id，多个文件时可逗号拼接存储，所以前端最后获取到的是逗号拼接的 id，前端调用接口先获取到文件的信息，其中包含原始的文件名，url 等信息，于是前端可下载并重命名为原始文件名。")]),t._v(" "),a("p",[t._v("前端已经封装好了 "),a("code",[t._v("ImgUpload")]),t._v(" 组件，可以非常方便的使用。路径为 "),a("code",[t._v("/src/components/ImgUpload")]),t._v("，组件也支持图片压缩功能。")]),t._v(" "),a("h2",{attrs:{id:"进阶"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#进阶"}},[t._v("#")]),t._v(" 进阶")]),t._v(" "),a("p",[t._v("如果有大文件断点续传的需求，这里推荐使用 "),a("a",{attrs:{href:"https://tus.io/",target:"_blank",rel:"noopener noreferrer"}},[t._v("tus 协议"),a("OutboundLink")],1),t._v("，支持大文件、分片、并发、断电续传、MD5 秒传（不要使用百度的 WebUploader）")]),t._v(" "),a("p",[t._v("前端："),a("a",{attrs:{href:"https://github.com/tus/tus-js-client",target:"_blank",rel:"noopener noreferrer"}},[t._v("tus-js-client"),a("OutboundLink")],1),t._v(" 或者 "),a("a",{attrs:{href:"https://github.com/transloadit/uppy",target:"_blank",rel:"noopener noreferrer"}},[t._v("@uppy/tus"),a("OutboundLink")],1),t._v(", ("),a("code",[t._v("@uppy/tus")]),t._v(" 其实就是 "),a("code",[t._v("tus-js-client")]),t._v(" 的包装)")]),t._v(" "),a("p",[t._v("后端："),a("a",{attrs:{href:"https://github.com/tomdesair/tus-java-server",target:"_blank",rel:"noopener noreferrer"}},[t._v("tus-java-server"),a("OutboundLink")],1)])])}),[],!1,null,null,null);e.default=r.exports}}]);